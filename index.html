<!doctype html>
<html>
  <head>
    <title>PostgreSQL Real-Time</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; height: 5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; height: 95%; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
   
  </head>
  
  <body>
    
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
     angular.module('myApp', []).controller('myCtrl', 
     function($scope) {
      $scope.entries = [];     
    var socketid= null;
    var socket = io();
      console.log("binding events");
     /* socket.on('con', function(msg){
        if(socketid !== msg){
          $scope.entries = [];
          $scope.$apply();
        }
      	console.log('con: ', msg);
           //socket.emit("loaded");
           socketid = msg;
      });*/
      
       socket.on('init', function(msg){
         $scope.entries = [];
        var response = JSON.parse(msg);
        for(i=0;i<response.length;i++){
          $scope.entries.push(response[i]);
        }
        $scope.$apply();
      });
      
      socket.on('insert', function(msg){
      	console.log('insert: ', msg);
        var newEntry = msg.substring(1, msg.length-1).split(',');
        var entry = {"id": newEntry[0], "name":newEntry[1]};
        if(!containsObject(entry,$scope.entries)){
          $scope.entries.push(entry);
          $scope.$apply();
        }
      });
	  
     
	    socket.on('update', function(msg){
        var newEntry = msg.substring(1, msg.length-1).split(',');
        var entry = {"id": newEntry[0], "name":newEntry[1]};
      	for(i=0;i<$scope.entries.length;i++){
          if($scope.entries[i].id ==  entry.id){
            $scope.entries[i] = entry;
            $scope.$apply();  
          }
        }
      });
	  
	    socket.on('delete', function(msg){
      	var newEntry = msg.substring(1, msg.length-1).split(',');
        var entry = {"id": newEntry[0], "name":newEntry[1]};
      	for(i=0;i<$scope.entries.length;i++){
          if($scope.entries[i].id ==  entry.id){
            $scope.entries.pop(i);
            $scope.$apply();  
          }
        }
      });
      
      function containsObject(obj, list) {
         var i;
         for (i = 0; i < list.length; i++) {
            if (list[i] === obj) {
              return true;
            }
        }
        return false;
      }
   });
    </script>
    <div ng-app="myApp" ng-controller="myCtrl">
      <div ng-repeat="entry in entries">
        <li>{{entry.name}}</li>
      </div>
    </div>
  </body>
</html>
